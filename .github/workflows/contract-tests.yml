name: Contract Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'api/**'
      - 'tests/contracts/**'
      - 'frontend/src/api.ts'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'api/**'
      - 'tests/contracts/**'
      - 'frontend/src/api.ts'

jobs:
  contract-tests:
    name: Consumer-Driven Contract Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: test_documents
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      opensearch:
        image: opensearchproject/opensearch:2.11.1
        env:
          discovery.type: single-node
          plugins.security.disabled: true
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 9200:9200

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r tests/contracts/requirements-contracts.txt

      - name: Set up Ollama (mock for testing)
        run: |
          # For contract tests, we'll mock the Ollama responses
          # In a real scenario, you'd run Ollama in a service container
          echo "Mocking Ollama for contract tests"

      - name: Validate contract files
        run: |
          python tests/contracts/test_api_contracts.py

      - name: Start API server
        run: |
          # Set test environment variables
          export DATABASE_URL="postgresql://postgres:testpassword@localhost:5432/test_documents"
          export OPENSEARCH_URL="http://localhost:9200"

          # Start the API server in background
          python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          API_PID=$!

          # Wait for API to be ready
          timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'

          echo "API server started with PID: $API_PID"

      - name: Run contract tests
        run: |
          # Run the actual contract verification tests
          python -m pytest tests/contracts/test_api_contracts.py::TestSearchContracts::test_search_documents_contract -v
          python -m pytest tests/contracts/test_api_contracts.py::TestDocumentContracts::test_get_document_contract -v
          python -m pytest tests/contracts/test_api_contracts.py::TestHealthContracts::test_health_check_contract -v

      - name: Generate contract reports
        run: |
          # Create contract test report
          mkdir -p contract-reports
          echo "# Contract Test Results" > contract-reports/results.md
          echo "" >> contract-reports/results.md
          echo "## Test Run: $(date)" >> contract-reports/results.md
          echo "" >> contract-reports/results.md
          echo "### Status: âœ… PASSED" >> contract-reports/results.md
          echo "" >> contract-reports/results.md
          echo "### Verified Contracts:" >> contract-reports/results.md
          echo "- Frontend â†” API Search" >> contract-reports/results.md
          echo "- Frontend â†” API Documents" >> contract-reports/results.md
          echo "- Frontend â†” API Health" >> contract-reports/results.md

      - name: Upload contract reports
        uses: actions/upload-artifact@v3
        with:
          name: contract-test-reports
          path: contract-reports/

  contract-verification:
    name: Contract Verification
    runs-on: ubuntu-latest
    needs: contract-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify contract changes
        run: |
          # Check if contracts have been properly updated
          if git diff --name-only HEAD~1 | grep -q "tests/contracts/"; then
            echo "Contracts have been modified - verification needed"
            # Additional verification logic could go here
          else
            echo "No contract changes detected"
          fi

      - name: Validate contract compatibility
        run: |
          # Check for breaking changes in contracts
          echo "Validating contract compatibility..."
          # This could include checking version compatibility
          # or running backward compatibility tests

  notify-contract-failures:
    name: Notify on Contract Failures
    runs-on: ubuntu-latest
    needs: [contract-tests, contract-verification]
    if: failure()

    steps:
      - name: Create issue on contract failure
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Contract Tests Failed',
              body: `
                ## ðŸš¨ Contract Tests Failed

                The Consumer-Driven Contract tests have failed. This indicates a potential breaking change in the API that may affect the frontend.

                ### What this means:
                - The API may have changed in a way that breaks frontend expectations
                - Frontend developers should review the failing contracts
                - API changes should be coordinated with frontend updates

                ### Next steps:
                1. Review the contract test failures
                2. Update contracts if the API changes are intentional
                3. Coordinate with frontend team for breaking changes
                4. Re-run tests after fixes

                ### Failed run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `,
              labels: ['contract-tests', 'breaking-change', 'needs-attention']
            })